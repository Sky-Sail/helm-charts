name: Trivy Security Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
  schedule:
    # Run weekly on Wednesday at 00:00 UTC
    - cron: '0 0 * * 3'

jobs:
  discover-charts:
    runs-on: ubuntu-latest
    outputs:
      charts: ${{ steps.find-charts.outputs.charts }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Find all charts
        id: find-charts
        run: |
          charts=$(find . -name 'Chart.yaml' -not -path './.git/*' -not -path './.github/*' | xargs dirname | xargs -I {} basename {})
          charts_json=$(echo "$charts" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "charts=$charts_json" >> $GITHUB_OUTPUT
          echo "Found charts: $charts_json"

  trivy-scan:
    needs: discover-charts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    strategy:
      matrix:
        chart: ${{ fromJson(needs.discover-charts.outputs.charts) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Trivy
        run: |
          VERSION=$(curl -s https://api.github.com/repos/aquasecurity/trivy/releases/latest | grep '"tag_name":' | sed -E 's/.*"v([^"]+)".*/\1/')
          wget -qO- https://github.com/aquasecurity/trivy/releases/download/v${VERSION}/trivy_${VERSION}_Linux-64bit.tar.gz | tar -xz
          sudo mv trivy /usr/local/bin/
          trivy --version

      - name: Run Trivy on chart
        id: trivy-scan
        run: |
          chart_dir="./${{ matrix.chart }}"
          echo "========================================="
          echo "Scanning chart: ${{ matrix.chart }}"
          echo "Chart directory: $chart_dir"
          echo "========================================="

          # Run Trivy config scan for misconfigurations
          echo "ðŸ” Scanning for misconfigurations..."
          trivy config \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output trivy-config-${{ matrix.chart }}.json \
            --exit-code 0 \
            "$chart_dir" || true

          # Run Trivy filesystem scan for secrets
          echo "ðŸ” Scanning for exposed secrets..."
          trivy fs --scanners secret \
            --severity CRITICAL,HIGH,MEDIUM \
            --format json \
            --output trivy-secret-${{ matrix.chart }}.json \
            --exit-code 0 \
            "$chart_dir" || true

          # Display table output for logs
          echo ""
          echo "ðŸ“‹ Misconfigurations:"
          trivy config --severity CRITICAL,HIGH,MEDIUM --format table --exit-code 0 "$chart_dir" || true

          echo ""
          echo "ðŸ” Secrets:"
          trivy fs --scanners secret --severity CRITICAL,HIGH,MEDIUM --format table --exit-code 0 "$chart_dir" || true

          # Count issues from JSON files
          critical=0
          high=0
          medium=0
          secrets=0

          if [ -f "trivy-config-${{ matrix.chart }}.json" ]; then
            critical=$(($critical + $(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "CRITICAL")] | length' trivy-config-${{ matrix.chart }}.json 2>/dev/null || echo "0")))
            high=$(($high + $(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "HIGH")] | length' trivy-config-${{ matrix.chart }}.json 2>/dev/null || echo "0")))
            medium=$(($medium + $(jq '[.Results[]?.Misconfigurations[]? | select(.Severity == "MEDIUM")] | length' trivy-config-${{ matrix.chart }}.json 2>/dev/null || echo "0")))
          fi

          if [ -f "trivy-secret-${{ matrix.chart }}.json" ]; then
            secrets=$(jq '[.Results[]?.Secrets[]? | select(.Severity == "CRITICAL" or .Severity == "HIGH")] | length' trivy-secret-${{ matrix.chart }}.json 2>/dev/null || echo "0")
          fi

          echo "critical=$critical" >> $GITHUB_OUTPUT
          echo "high=$high" >> $GITHUB_OUTPUT
          echo "medium=$medium" >> $GITHUB_OUTPUT
          echo "secrets=$secrets" >> $GITHUB_OUTPUT

          echo ""
          echo "ðŸ“Š Scan Results for ${{ matrix.chart }}:"
          echo "  CRITICAL: $critical"
          echo "  HIGH: $high"
          echo "  MEDIUM: $medium"
          echo "  Exposed Secrets: $secrets"
          echo ""

          if [ "$critical" -gt 0 ] || [ "$high" -gt 0 ] || [ "$secrets" -gt 0 ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "âŒ Security issues found in ${{ matrix.chart }}"
            exit 1
          else
            echo "status=success" >> $GITHUB_OUTPUT
            echo "âœ… Chart ${{ matrix.chart }} passed security scan"
          fi

      - name: Upload Trivy SARIF results
        uses: aquasecurity/trivy-action@master
        if: always()
        with:
          scan-type: 'config'
          scan-ref: './${{ matrix.chart }}'
          format: 'sarif'
          output: 'trivy-${{ matrix.chart }}.sarif'
          severity: 'CRITICAL,HIGH'

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-${{ matrix.chart }}.sarif'
          wait-for-processing: false

  summary:
    needs: [discover-charts, trivy-scan]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Scan Summary
        run: |
          echo "## Trivy Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All charts have been scanned for security issues." >> $GITHUB_STEP_SUMMARY

